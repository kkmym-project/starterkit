# CI/CD
![ci-cd-flow](../imgs/ci-cd-flow.png)

## CI/CDとは
クラウドネイティブなアプリケーションには欠かせない重要な要素です。  
CNCF のTrail Map ではオーケストレーション（ECS, K8s）より先に取り上げられているほど重要です。コンテナ化の次はECSやK8sではなくCI/CDを導入しましょう。

## CI
継続的インテグレーション（Continuous Integration）です。  
リポジトリにpushされたコードを自動的にビルド&テストを実行し、開発物の品質担保を行います。  
開発時から意識しておく必要があり、自動テスト可能な設計/開発を行う必要と、事前のチーム内での合意（いつCIを実行するかなど）が必要があります。

弊社ではCircleCI Enterprise が導入されています。  
GitHub Enterprise とスムーズに連携可能です。例えば他のCIツールであればIP開放申請や自前ホストが必要になります。  

最初は以下の2つを意識すると良いでしょう

1. プロダクトにテストを導入する
    - e.g. PHPUnit, rspec, jest
2. PR時にテストを通す
    - CircleCI Enterprise を使用する
    - コードレビューはCIが通ってから実施するよう合意する

この先はテストの並列化、静的解析、カバレッジ計測、結合テスト、負荷試験など、サービスの品質を担保するための仕組みを整えましょう。  
基本的にCIはクラウド的な難しさよりアプリケーション的な難しさの方が大きいでしょう。

## CD
継続的デリバリ（Continous Delivery）もしくは継続的デプロイメント（Continous Deployment）です。  
それぞれの違いはApproveを行うかどうからしいですが、リアルワールドで厳密に区別されてるようには見えません（デリバリがApproveを実行する、デプロイがApproveなしでデプロイすることです）。この2つの違いはチーム内で認識があっていれば特に意識する必要はないでしょう。  

現状過渡期に見えていて、主要なツールとしては各クラウドベンダーのSaaS・Argo CD・Fluxなど様々なプロダクトが選択されているようにみえます。  
筆者としてはArgoを推したいです。単純なCD（Argo CD）だけでなく、高機能なデプロイ戦略（Argo Rollout）・ワークフローの実行（Argo Workflow）など、サービス構築時に欲しくなる機能が揃っています。  
単純なCDだけであれば高機能すぎますが、将来的に投資可能であったりワークフローなどの機能が必要な場合は選択すると良いでしょう。  

スモールスタートの場合は各クラウドベンダーのSaaSを使用するといいでしょう。  
AWSであればCode兄弟（CodePipeline, CodeBuild, CodeDeploy）、GCPであればCloud Build です。各種SaaSはドキュメントが整理されており、一般的に使用されることが多くドキュメントや事例が豊富で、ベンダーからのサポートも受けられます。  
まずはCode兄弟を選択すると良いでしょう。

導入時にはどのプロダクトであっても以下に気をつける必要があると考えます。

1. CDするタイミング
    - CDはCIが通っていることが前提。それを前提にデプロイする仕組みにする。
    - 例えばdevelopブランチにpushがあったらステージングへ、masterブランチへpushがあったらプロダクションへ、それぞれデプロイされるようにする
2. 環境を意識する
    - 一般的にプロダクション環境だけでなく、ステージングや開発環境が存在し、それらの差分をなるべく少なくする。
    - 開発環境はカジュアルにローカルからデプロイできていいが、ステージングとプロダクションはGitに上がってるコードが正になるようにするなど。
    - ステージング・プロダクションの2パターンだけ考慮していると、あとからQAや負荷試験の環境が来たときに詰む。
        - 最初から「何環境あるか」を考えるのではなく、最初から「環境を増やせる」ようにする。
3. 監視をする
    - デプロイは障害を起こす可能性があり、変更に気付ける仕組みが必要。
        - これがないとデプロイに複雑なフローが必要になってしんどい。デプロイに上長承認が必要になるなど。
4. migrationの実行
    - DBのmigrationをCDパイプラインの中に組み込む
        - migrationが必要ないデプロイでもデプロイサイクルの中で実行する
    - migrationは「1デプロイ1回」を意識する
        - 1デプロイサイクルで1度だけ実行する。間違っても「コンテナ起動時にmigrationを置こうなう」ようにしてはならない
    - ローカルからDB migrationをするとデプロイ手法が複雑になる。
        - DB mgirationは下位互換性を完全に担保する。特定のカラムが不要になっても削除しないなど。
        - ロールバック手順は明記する。即座にロールバックできるようREADMEやWikiに書いておく。
5. デプロイ手法の統一
    - サービスが1つだけなら問題ないですが、複数に増えてくるとデプロイ手法が別れてつらくなることがある。
        - 「masterブランチにマージしたら」「tagをつけたら」「Jenkinsのジョブを実行したら」などなど...
        - デプロイ手法が混在すると安易にデプロイできなくなり、開発サイクルが遅くなる
    - デプロイ手法はチーム内で合意できていることが重要。
        - 迷ったらdevelopブランチにpushがあったらステージングへ、masterブランチへpushがあったらプロダクションへ、それぞれデプロイされるようにする

CDは導入が難しく、1回導入してしまえば完了するため知見が貯めづらいです。  
ですが、やることは決まっているかつ導入してしまえば完了するので導入してしまえばこっちのものです。  
また、サービスの成長によってマイクロサービス化が進むとデプロイにサービス間の疎通やその接続方法などなどの問題が絡んできます。  
個人的にCDは、サービスが増えてくると、技術的な難しさより組織論的な難しさが勝ってくると思っています。マイクロサービス化はチームだけでなく社での合意が必要になると考えます。それに失敗すると「IP制限」や「 `/etc/hosts` 」や「Authプロトコル」や、チーム間の繋がりが難しくなってきます。
